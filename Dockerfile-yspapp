# 基础镜像：使用 Python 3.9  slim 版本（平衡体积和兼容性）
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 解决跨架构构建时的依赖编译问题：安装通用编译工具 + 清理缓存
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc6-dev \
    make \
    && rm -rf /var/lib/apt/lists/*  # 清理 apt 缓存，减小镜像体积

# 复制依赖文件（确保 GitHub 仓库中该文件存在且名称一致）
COPY requirements-yspapp.txt .

# 优化 pip 安装：使用国内源（加速 GitHub Actions 构建）+ 无缓存
RUN pip install --no-cache-dir \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    -r requirements-yspapp.txt

# 复制脚本文件（确保 GitHub 仓库中 yspapp.py 存在）
COPY yspapp.py .

# 暴露端口（与脚本中 uvicorn 监听端口一致）
EXPOSE 8080

# 启动命令：明确指定 host 和 port（避免容器内网络问题）
CMD ["python", "yspapp.py"]
