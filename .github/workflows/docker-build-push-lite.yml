name: DPanel-lite
 
on:
  workflow_dispatch:
#  push:
#    branches:
#      - main 
#    tags:
#      - 'v*'  # 添加标签触发支持 
 
jobs:
  build:
    runs-on: ubuntu-latest 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 
        with:
          fetch-depth: 0  # 获取完整历史记录用于版本检测
 
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all  # 启用所有架构模拟

      - name: Set up Docker Buildx 
        uses: docker/setup-buildx-action@v3 
        with:
          version: latest  # 强制最新版 Buildx
          driver-opts: env.BUILDKIT_STEP_LOG_MAX_SIZE=104857600 

      - name: Log in to Docker Hub 
        uses: docker/login-action@v3 
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
 
      - name: Determine version 
        id: version
        run: |
          # 尝试从VERSION文件获取版本
          if [ -f "VERSION" ]; then
            echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT
          # 尝试从Git标签获取版本 (格式 v1.2.3)
          elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then 
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          # 使用提交哈希作为后备方案 
          else
            echo "VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi 
          
      - name: Build and push Docker images 
        uses: docker/build-push-action@v5 
        with:
          context: .
          push: true 
          tags: |
            taoxg/dpanel:lite
            taoxg/dpanel:${{ steps.version.outputs.VERSION }}
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          build-args: |
            APP_VERSION=${{ steps.version.outputs.VERSION }}
          # 缓存优化
          cache-from: type=registry,ref=taoxg/dpanel:buildcache
          cache-to: type=registry,ref=taoxg/dpanel:buildcache,mode=max
          pull: true  
          provenance: false  # 关闭溯源（减少模拟负担）
          
      - name: Verify multi-architecture images
        run: |
          set -e
          # 安装crane（轻量镜像校验工具）
          curl -sSL https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz | tar xzf - crane
          chmod +x crane

          # 1. 校验镜像架构清单
          echo "=== Checking image manifest ==="
          crane manifest taoxg/dpanel:lite | jq '.manifests[].platform'
          # 验证架构数量是否为3（amd64/arm64/arm/v7）
          MANIFEST_COUNT=$(crane manifest taoxg/dpanel:lite | jq '.manifests | length')
          if [ "$MANIFEST_COUNT" -ne 3 ]; then
            echo "Error: Expected 3 architectures, got $MANIFEST_COUNT"
            exit 1
          fi

          # 2. 验证每个架构的镜像可启动（后台启动+主动停止）
          echo -e "\n=== Verifying each architecture ==="
          ARCHES=("linux/amd64" "linux/arm64" "linux/arm/v7")
          for ARCH in "${ARCHES[@]}"; do
            CONTAINER_NAME="dpanel-test-$(echo $ARCH | tr '/' '-')"
            echo -e "\n--- Testing $ARCH (container: $CONTAINER_NAME) ---"
            
            # 后台启动容器
            docker run -d --name $CONTAINER_NAME --platform $ARCH taoxg/dpanel:lite
            
            # 等待服务初始化（amd64=3秒，ARM=8秒）
            SLEEP_TIME=$([[ $ARCH == "linux/amd64" ]] && echo 3 || echo 8)
            sleep $SLEEP_TIME
            
            # 检查容器是否运行（未崩溃）
            if [ $(docker inspect -f '{{.State.Running}}' $CONTAINER_NAME 2>/dev/null || echo "false") != "true" ]; then
              echo "Error: $ARCH container exited unexpectedly!"
              docker logs $CONTAINER_NAME || true
              docker rm -f $CONTAINER_NAME || true
              exit 1
            fi
            
            # 检查服务启动成功日志
            if ! docker logs $CONTAINER_NAME | grep -q "Host: 0.0.0.0,Port: 8080"; then
              echo "Error: $ARCH service did not start correctly!"
              docker logs $CONTAINER_NAME || true
              docker rm -f $CONTAINER_NAME || true
              exit 1
            fi
            
            # 停止并清理容器
            docker stop $CONTAINER_NAME && docker rm $CONTAINER_NAME
            echo "✅ $ARCH verify success"
          done

          # 清理临时文件
          rm -f crane
          echo -e "\n=== All architectures verified successfully ==="

      # 8. 输出构建结果（方便查看）
      - name: Print build summary
        run: |
          echo "✅ Build completed successfully!"
          echo "Image tags:"
          echo "  taoxg/dpanel:lite"
          echo "  taoxg/dpanel:${{ steps.version.outputs.VERSION }}"
          echo "Architectures: linux/amd64, linux/arm64, linux/arm/v7"
