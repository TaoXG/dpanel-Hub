# 1. 锁定Python版本+Debian版本，避免架构兼容问题
FROM python:3.9-slim-bullseye

# 2. 设置环境变量：强制pip使用纯Python版OpenCV（避免二进制架构不兼容）
ENV OPENCV_PYTHON_NO_BUILD=1
ENV PIP_DEFAULT_TIMEOUT=300
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# 3. 工作目录
WORKDIR /app

# 4. 安装系统依赖（精简+适配多架构）
RUN apt-get update --fix-missing -yq \
    && apt-get install -yq --no-install-recommends \
       # OpenCV必需依赖
       libgl1-mesa-glx \
       libglib2.0-0 \
       # 可选：构建OpenCV依赖（如果需要源码安装）
       gcc \
       g++ \
       cmake \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/*

# 5. 复制依赖文件（优先用requirements.txt，明确版本）
COPY requirements-slide.txt .

# 6. 安装Python依赖（关键修复：指定兼容版本+架构适配）
RUN pip install --no-cache-dir \
    # 指定兼容多架构的版本
    opencv-python==4.5.5.62 \
    numpy==1.23.5 \
    bottle==0.12.25 \
    # 修复QEMU仿真下的权限问题
    --user \
    # 强制使用国内源（GitHub海外环境也可访问）
    -i https://pypi.tuna.tsinghua.edu.cn/simple

# 7. 复制脚本
COPY slide.py .

# 8. 暴露端口
EXPOSE 3001

# 9. 启动命令（指定用户目录的Python包）
CMD ["python", "-u", "-m", "slide.py"]
