# 基础镜像：锁定Python 3.9-slim的Debian版本（bullseye），提升稳定性
FROM python:3.9-slim-bullseye

# 设置工作目录
WORKDIR /app

# 关键：不替换源，直接用官方源安装依赖（GitHub构建环境访问官方源无压力）
# 添加 -yq 静默安装，--fix-missing 修复依赖索引
RUN apt-get update --fix-missing -yq \
    && apt-get install -yq --no-install-recommends \
    libgl1-mesa-glx \
    libglib2.0-0 \
    # 可选：curl用于健康检查
    curl \
    # 清理缓存，减少镜像体积
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 设置pip源（GitHub构建可访问清华源，也可改用官方源）
RUN pip config set global.index-url https://pypi.org/simple

# 复制依赖文件
COPY requirements-slide.txt .

# 安装Python依赖（增加超时，避免网络波动）
RUN pip install --no-cache-dir --default-timeout=300 \
    opencv-python \
    numpy \
    bottle

# 复制脚本文件
COPY slide.py .

# 暴露端口
EXPOSE 3001

# 健康检查（可选）
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD curl -f http://localhost:3001/ || exit 1

# CMD 使用JSON格式，消除警告
CMD ["python", "-u", "slide.py"]
