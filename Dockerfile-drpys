FROM node:22.16.0-alpine3.20

# 1. 清理缓存 + 配置国内PyPI源
RUN rm -rf /var/cache/apk/* && \
    mkdir -p /root/.pip && \
    echo "[global]" > /root/.pip/pip.conf && \
    echo "index-url = https://mirrors.aliyun.com/pypi/simple/" >> /root/.pip/pip.conf && \
    echo "trusted-host = mirrors.aliyun.com" >> /root/.pip/pip.conf

# 2. 安装依赖（所有参数用4个空格缩进，确保完全一致）
RUN apk add --no-cache \
    bash \
    coreutils \
    curl \
    python3 \
    py3-pip \
    py3-setuptools \
    ca-certificates \
    gcc \
    musl-dev \
    python3-dev \
    libxml2-dev \
    libxslt-dev \
    tzdata

# 3. 验证Python环境
RUN echo "Python版本: $(python3 --version)" && \
    echo "pip版本: $(python3 -m pip --version)"

# 4. 设置时区
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    rm -rf /var/cache/apk/*

# 5. 安装Python依赖
RUN python3 -m pip install --no-cache-dir requests
RUN python3 -m pip install --no-cache-dir lxml
RUN python3 -m pip install --no-cache-dir pycryptodome
RUN python3 -m pip install --no-cache-dir ujson
RUN python3 -m pip install --no-cache-dir pyquery
RUN python3 -m pip install --no-cache-dir jsonpath
RUN python3 -m pip install --no-cache-dir json5
RUN python3 -m pip install --no-cache-dir jinja2
RUN python3 -m pip install --no-cache-dir cachetools
RUN python3 -m pip install --no-cache-dir pympler

WORKDIR /drpy-node
EXPOSE 5757
CMD ["node", "index.js"]
