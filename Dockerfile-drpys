FROM node:22.16.0-alpine3.20

# 1. 安装核心依赖（包含curl，解决命令未找到问题）
RUN apk add --no-cache \
    python3 \
    py3-pip \
    ca-certificates \
    curl  # 必须安装curl，否则网络验证失败

# 2. 配置国内PyPI源（解决网络问题，无需复杂验证）
RUN mkdir -p /root/.pip && \
    echo "[global]" > /root/.pip/pip.conf && \
    echo "index-url = https://mirrors.aliyun.com/pypi/simple/" >> /root/.pip/pip.conf && \
    echo "trusted-host = mirrors.aliyun.com" >> /root/.pip/pip.conf

# 3. 直接安装Python依赖（用--verbose输出详细日志定位问题）
RUN python3 -m pip install --no-cache-dir --verbose requests
RUN python3 -m pip install --no-cache-dir --verbose lxml
RUN python3 -m pip install --no-cache-dir --verbose pycryptodome
RUN python3 -m pip install --no-cache-dir --verbose ujson
RUN python3 -m pip install --no-cache-dir --verbose pyquery
RUN python3 -m pip install --no-cache-dir --verbose jsonpath
RUN python3 -m pip install --no-cache-dir --verbose json5
RUN python3 -m pip install --no-cache-dir --verbose jinja2
RUN python3 -m pip install --no-cache-dir --verbose cachetools
RUN python3 -m pip install --no-cache-dir --verbose pympler

# 4. 基础配置（时区、工作目录等）
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

WORKDIR /drpy-node
EXPOSE 5757
CMD ["node", "index.js"]
