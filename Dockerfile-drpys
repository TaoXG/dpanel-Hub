# 使用稳定的基础镜像
FROM node:22.16.0-alpine3.20

# 初始化包管理
RUN rm -rf /var/cache/apk/* && \
    apk update --no-cache && \
    apk upgrade --no-cache

# 设置时区
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    rm -rf /var/cache/apk/*

# 安装系统依赖 - 分开安装以减少缓存问题
RUN apk add --no-cache python3 py3-pip
RUN apk add --no-cache gcc musl-dev python3-dev libxml2-dev libxslt-dev
RUN apk add --no-cache nodejs npm bash curl coreutils

# 简化Python包安装过程，避免复杂的脚本转义
RUN pip3 install --no-cache-dir --upgrade pip && \
    pip3 install --no-cache-dir requests && \
    pip3 install --no-cache-dir lxml && \
    pip3 install --no-cache-dir pycryptodome && \
    pip3 install --no-cache-dir ujson && \
    pip3 install --no-cache-dir pyquery && \
    pip3 install --no-cache-dir jsonpath && \
    pip3 install --no-cache-dir json5 && \
    pip3 install --no-cache-dir jinja2 && \
    pip3 install --no-cache-dir cachetools && \
    pip3 install --no-cache-dir pympler

WORKDIR /drpy-node

EXPOSE 5757

# JSON格式CMD
CMD ["node", "index.js"]
    
