FROM node:22.16.0-alpine3.20

# 1. 清理缓存 + 设置国内PyPI源（解决网络问题）
RUN rm -rf /var/cache/apk/* && \
    # 配置阿里云PyPI源，加速安装并避免国外源连接问题
    mkdir -p /root/.pip && \
    echo "[global]" > /root/.pip/pip.conf && \
    echo "index-url = https://mirrors.aliyun.com/pypi/simple/" >> /root/.pip/pip.conf && \
    echo "trusted-host = mirrors.aliyun.com" >> /root/.pip/pip.conf

# 2. 安装基础工具 + Python环境（一次性安装，避免分步冲突）
RUN apk add --no-cache \
    bash \
    coreutils \
    curl \
    python3 \
    py3-pip \
    py3-setuptools \
    ca-certificates \  # 解决SSL证书问题
    gcc \              # 编译依赖
    musl-dev \
    python3-dev \
    libxml2-dev \
    libxslt-dev \
    tzdata

# 3. 验证Python环境（确认基础功能正常）
RUN echo "Python版本: $(python3 --version)" && \
    echo "pip版本: $(python3 -m pip --version)"

# 4. 设置时区
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    rm -rf /var/cache/apk/*

# 5. 关键修复：不升级pip，直接用系统预装pip安装依赖
# （Alpine预装的pip已足够用，升级反而可能引发路径冲突）
RUN python3 -m pip install --no-cache-dir requests
RUN python3 -m pip install --no-cache-dir lxml
RUN python3 -m pip install --no-cache-dir pycryptodome
RUN python3 -m pip install --no-cache-dir ujson
RUN python3 -m pip install --no-cache-dir pyquery
RUN python3 -m pip install --no-cache-dir jsonpath
RUN python3 -m pip install --no-cache-dir json5
RUN python3 -m pip install --no-cache-dir jinja2
RUN python3 -m pip install --no-cache-dir cachetools
RUN python3 -m pip install --no-cache-dir pympler

WORKDIR /drpy-node
EXPOSE 5757
CMD ["node", "index.js"]
