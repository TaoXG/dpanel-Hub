# 使用更稳定的基础镜像版本
FROM node:22.16.0-alpine3.20

# 完全重新初始化包管理，确保没有缓存干扰
RUN rm -rf /var/cache/apk/* && \
    apk update --no-cache && \
    apk upgrade --no-cache

# 设置时区
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    rm -rf /var/cache/apk/*

# 使用 apk 安装依赖
RUN apk add --no-cache \
    python3 \
    py3-pip \
    py3-setuptools \
    py3-wheel \
    gcc \
    musl-dev \
    python3-dev \
    libxml2-dev \
    libxslt-dev \
    nodejs \
    npm \
    bash \
    curl \
    coreutils && \
    rm -rf /var/cache/apk/*

# 单独创建一个安装脚本，避免命令行缓存问题
RUN echo '#!/bin/sh\n\
python3 -m ensurepip --upgrade\n\
pip3 install --no-cache-dir --upgrade pip\n\
pip3 install --no-cache-dir \\\n\
requests \\\n\
lxml \\\n\
pycryptodome \\\n\
ujson \\\n\
pyquery \\\n\
jsonpath \\\n\
json5 \\\n\
jinja2 \\\n\
cachetools \\\n\
pympler' > /install_python_packages.sh && \
    chmod +x /install_python_packages.sh && \
    /install_python_packages.sh && \
    rm /install_python_packages.sh

WORKDIR /drpy-node

EXPOSE 5757

# 使用JSON格式的CMD以解决警告
CMD ["node", "index.js"]
    
