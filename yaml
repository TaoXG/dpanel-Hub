name: DPanel-lite Multi-Arch Build

# 触发条件：手动触发 + 标签推送（可选）
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'  # 标签以 v 开头时触发（如 v1.9.2）

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 超时时间（防止无限卡住）
    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整Git历史，用于版本检测

      # 2. 配置QEMU（全架构模拟支持）
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all  # 启用所有架构模拟（amd64/arm64/arm/v7）

      # 3. 配置Docker Buildx（最新版，修复多架构兼容）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: latest
          driver-opts: |
            env.BUILDKIT_STEP_LOG_MAX_SIZE=104857600  # 增大日志缓冲区
            env.BUILDKIT_PROGRESS=plain               # 输出详细构建日志

      # 4. 登录Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 5. 自动识别版本（优先级：VERSION文件 > Git标签 > 提交哈希）
      - name: Determine image version
        id: version
        run: |
          set -e
          if [ -f "VERSION" ]; then
            VERSION=$(cat VERSION | tr -d ' \n')
          elif [[ "${{ github.ref_name }}" == v* ]]; then
            VERSION=${{ github.ref_name }}#v}  # 去掉标签前缀v
          else
            VERSION=$(git rev-parse --short HEAD)  # 提交哈希作为兜底
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      # 6. 构建并推送多架构镜像（带缓存优化）
      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 镜像标签：固定lite + 版本号
          tags: |
            taoxg/dpanel:lite
            taoxg/dpanel:${{ steps.version.outputs.VERSION }}
          # 目标架构
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          # 构建参数
          build-args: |
            APP_VERSION=${{ steps.version.outputs.VERSION }}
          # 缓存优化（加速后续构建）
          cache-from: type=registry,ref=taoxg/dpanel:buildcache
          cache-to: type=registry,ref=taoxg/dpanel:buildcache,mode=max
          # 减少模拟负担
          pull: true
          provenance: false
          sbom: false

      # 7. 验证多架构镜像（防阻塞，主动停止容器）
      - name: Verify multi-architecture images
        run: |
          set -e
          # 安装crane（轻量镜像校验工具）
          curl -sSL https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz | tar xzf - crane
          chmod +x crane

          # 1. 校验镜像架构清单
          echo "=== Checking image manifest ==="
          crane manifest taoxg/dpanel:lite | jq '.manifests[].platform'
          # 验证架构数量是否为3（amd64/arm64/arm/v7）
          MANIFEST_COUNT=$(crane manifest taoxg/dpanel:lite | jq '.manifests | length')
          if [ "$MANIFEST_COUNT" -ne 3 ]; then
            echo "Error: Expected 3 architectures, got $MANIFEST_COUNT"
            exit 1
          fi

          # 2. 验证每个架构的镜像可启动（后台启动+主动停止）
          echo -e "\n=== Verifying each architecture ==="
          ARCHES=("linux/amd64" "linux/arm64" "linux/arm/v7")
          for ARCH in "${ARCHES[@]}"; do
            CONTAINER_NAME="dpanel-test-$(echo $ARCH | tr '/' '-')"
            echo -e "\n--- Testing $ARCH (container: $CONTAINER_NAME) ---"
            
            # 后台启动容器
            docker run -d --name $CONTAINER_NAME --platform $ARCH taoxg/dpanel:lite
            
            # 等待服务初始化（amd64=3秒，ARM=8秒）
            SLEEP_TIME=$([[ $ARCH == "linux/amd64" ]] && echo 3 || echo 8)
            sleep $SLEEP_TIME
            
            # 检查容器是否运行（未崩溃）
            if [ $(docker inspect -f '{{.State.Running}}' $CONTAINER_NAME 2>/dev/null || echo "false") != "true" ]; then
              echo "Error: $ARCH container exited unexpectedly!"
              docker logs $CONTAINER_NAME || true
              docker rm -f $CONTAINER_NAME || true
              exit 1
            fi
            
            # 检查服务启动成功日志
            if ! docker logs $CONTAINER_NAME | grep -q "Host: 0.0.0.0,Port: 8080"; then
              echo "Error: $ARCH service did not start correctly!"
              docker logs $CONTAINER_NAME || true
              docker rm -f $CONTAINER_NAME || true
              exit 1
            fi
            
            # 停止并清理容器
            docker stop $CONTAINER_NAME && docker rm $CONTAINER_NAME
            echo "✅ $ARCH verify success"
          done

          # 清理临时文件
          rm -f crane
          echo -e "\n=== All architectures verified successfully ==="

      # 8. 输出构建结果（方便查看）
      - name: Print build summary
        run: |
          echo "✅ Build completed successfully!"
          echo "Image tags:"
          echo "  taoxg/dpanel:lite"
          echo "  taoxg/dpanel:${{ steps.version.outputs.VERSION }}"
          echo "Architectures: linux/amd64, linux/arm64, linux/arm/v7"
